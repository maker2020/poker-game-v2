# 斗地主小程序开发需求说明

仍处于集思广益阶段，这是一个初步、简单、暂定的**开发**需求说明。

## 简单说明

按照客户端/服务器特点来划分。

### 客户端、服务器协调

1. 微信用户授权取得用户信息（包含唯一标识name/id)。
2. 游戏系统数据持久化到数据库。
    - 用户信息：微信账号相关、游戏道具货币等信息。
    - 游戏系统：游戏道具等。
    - ......
    - (待补全)
3. 游戏互动(表情、固定聊天语录)。
4. 广告植入（结合道具奖励）。
5. 游戏热更新。
6. 前端数据的面向对象封装，优化前后端数据对接。

### 客户端

1. 单机模式的开发（含联机托管）。
2. 游戏音效加入。

### 服务器

1. 游戏断连重连机制。
2. 安全要求（涉及面较广）。
3. 内存清理优化。

## 三高要求

高并发、高性能、高可靠。

数据量上来后，考虑分布式系统常用的并发组件。

1. RabbitMQ(中转生产者的消息，削峰填谷)
2. 数据库主从+集群+读写分离(可靠+高性能)
3. Netty进阶使用(三高)

## 安全性

1. 接口安全性:
由于小程序类似浏览器的web服务等技术，它也可以被查看源码。接口的安全性必须通过token认证、敏感数据必须加密、有效利用微信云函数(参数cloudID)。

2. 后端数据校验的严谨性。

3. 并发问题:

   - 得益于Netty单线程处理事件的机制，有效防止了多次重复请求的问题（如连续抢地主等，在第一次请求处理完后才会处理第二次请求，但此时Acting变量已被改变，此次请求被拦截返回）
   - 计时器只会针对某个PlayerID来限制或解除限制，而防止先后顺序不一致导致并发问题（如抢地主后解除ASK的限时并置空标识，但系统轮询PUT的判断却早一步进入计时器方法导致并发问题，因此计时器方法针对PlayerID加锁)

## 具体说明

- 场上倍数规则:
    1. 炸弹翻倍
    2. 地主牌同花顺翻倍
    3. 地主牌大小王任意一张翻倍
    4. 抢地主翻倍

## Spring还是非Spring?

这个问题考虑到Spring应用在常用的web业务上使用简单方便，而想要更灵活的管理大量bean并不容易，特别是要按照条件有选择的注入bean和控制bean等问题。另外，目前Netty框架下的游戏管理较为熟悉。**综合考虑可以先继续于Spring框架之外开发，在netty下成熟后，再考虑能否利用Spring管理的优势优化服务器**。

## WebSocket相关

- 数据传输: 后端待使用更简洁、更统一的方式传输对象/数据。
